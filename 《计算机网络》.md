# 一、概述

计算机网络 - 一些互联的、自治的计算机系统的集合；

## I. 分类

按分布范围分类：

广域网(WAN) > 城域网(MAN) > 局域网(LAN) > 个人区域网(PAN)；

按传输技术分类：

广播式、点对点式；

## II. 性能指标

(1) **带宽** 

表示数字信道所能传送的最高数据率，单位byte/s；

(2) **时延**

表示数据从网络的一端传送到另一端所需要的总时间；

时延 = 发送时延 + 传播时延 + 处理时延 + 排队时延；

(3) **时延带宽积**

表示发送端连续发送数据时，发送的第一个比特到达接收端时，发送端已经发出的比特数；

时延带宽积 = 传播时延 * 带宽；

(4) **往返时延**

表示发送端从发送数据开始，到接收到接收端返回数据的总时间；

(5) **吞吐量**

表示单位时间内某个网络的数据量；

(6) **速率**

表示信道传输数据的速率，单位byte/s；

## III. 网络模型

### OSI七层模型

|            | 功能                                                         |
| ---------- | ------------------------------------------------------------ |
| 物理层     | 单位：比特；<br />与物理设备通信，传输原始比特流；<br />功能：<br />① 规定接口的一些参数，如机械形状、尺寸、排列等；<br />② 规定了信号与电气特征之间的对应（如电压高于3.3V为1，否则为0）； |
| 数据链路层 | 单位：帧；<br />功能：<br />① 将网络层传来的IP数据报组装成帧；<br />② 对收到外界干扰而出现错误的比特流进行差错控制，丢弃错误信息；<br />③ 协调接口之间的发送、接收速率； |
| 网络层     | 单位：数据报；<br />功能：<br />① 路由控制，即根据算法选择合适的路由路径；<br />② 流量控制，协调发送和接收速率；<br />③ 差错控制，纠正或丢弃错误数据；<br />④ 拥塞控制； |
| 传输层     | 单位：报文段（TCP）或用户数据报（UDP）；<br />功能：<br />主机中两个进程之间的流量控制、差错控制、数据传输服务； |
| 会话层     | 允许不同主机上的各个进程进行会话；                           |
| 表示层     | 处理两个通信系统中信息交换方式的不同；                       |
| 应用层     | 与用户进行交互；                                             |

### TCP/IP四层模型

|            | 功能                                                         |
| ---------- | ------------------------------------------------------------ |
| 网络接口层 | 将物理层和数据链路层统一看作物理网络层，网络接口指的是抽象网络与物理网络之间的接口； |
| 网际层     | 将数据分组发往各个网络，并规划路由，但并不保证各个分组有序达到；<br />使用IP协议； |
| 传输层     | 使得发送端与接收端主机上的对等实体进行会话；<br />使用TCP或UDP模型； |
| 应用层     | 与用户进行交互；                                             |



# 二、物理层

## I. 基本概念

**数据** - 传送信息的实体；

**信号** - 数据在传输过程中的存在形式；

**码元** - 用一个固定时长的信号波形表示一位某个进制的数字，即一个脉冲信号；

​			一个码元可以携带一个或多个比特的信息（取决于使用的进制）；

**比特率** - 即信息传输速率，指单位时间内传输的比特数；

**波特率** - 即码元传输速率，指单位时间内传输的码元数；

​				若一个码元可以携带$n$个比特的数据，则比特率/波特率 = $n$；

**奈奎斯特定理**

对于理想低通信道（无噪声、带宽有限），设信道带宽为$W$​，一个码元表示$k$进制数字，则
$$
BaudRate_{max}=2W \log_2k
$$
结论：

​	① 波特率有上限，超过该上限会出现严重的串码干扰问题；

​	② 虽然波特率有上限，但没有限定进制$k$，也就没有限定比特率的上限；

​	③ 要想提高波特率，可以提高信号带宽和进制数；

**香浓定理**

对于带宽受限且有高斯白噪声干扰的信道，设信道带宽为$W$，信道传输的平均功率为$S$，信道内部的高斯噪声功率为$N$，则
$$
BitRate_{max}=W\log_2(1+\frac{S}{N})
$$
结论：

​	① 比特率是有上限的，虽然有噪声影响，但只要不超过该上限，就能找到一种方法实现无差错的传输；

​	② 信噪比越大，极限传输速率越高；

**信噪比**

设传输信号的平均功率为$S$，噪声的平均功率为$N$，则信噪比为$10\log_{10}\frac{S}{N}$​；

**数字信号和模拟信号**

数字信号 - 时间离散，信号幅值离散（矩形波）；

模拟信号 - 时间连续，信号幅值连续（正弦波）；

**编码与调制**

编码 - 把数据变换为数字信号；

调制 - 把数据变换为模拟信号；

|                        | 说明                                                         |
| ---------------------- | ------------------------------------------------------------ |
| 数字数据编码为数字信号 | 常用编码方式：<br />① 非归零编码(NRZ)：高电平表示1，低电平表示0；<br />② 曼彻斯特编码：将一个码元一分为二，前高后低为1，前低后高为0；<br />③ 差分曼彻斯特编码：与前半个码元电平相等为1，否则为0；<br />④ 4B/5B编码：分组并转换为对应的4/5位码发送； |
| 数字数据调制位模拟信号 | 常用调制方式：<br />① 幅移键控(ASK)：改变振幅来表示1和0；<br />② 频移键控(FSK)：改变频率来表示1和0；<br />③ 相移键控(PSK)：改变相位来表示1和0；<br />④ 正交振幅调制(QAM)：频率不变，结合ASK和PSK； |
| 模拟数据编码为数字信号 | 采用 + 量化 + 编码                                           |
| 模拟数据调制为模拟信号 | 需要提高频率                                                 |

**电路交换、报文交换、分组交换**

(1) 电路交换

在数据传输前，两个结点之间需要有一条专用的物理通信路径，这一路径在通信期间会一直被占用；

通信路径建立后，除源结点和目标结点外，路径中间的所有结点都直接传递数据而不进行存储转发；

优点：简单，不存在冲突，通信时延小；

缺点：不灵活，效率低，建立连接需要的时间长；

(2) 报文交换

报文中带有目标地址、源地址等信息，每个结点都需要进行存储转发；

优点：无需建立特定连接、灵活、效率高，一个报文可以同时给多个目标；

缺点：存储转发导致较高时延，且对结点的缓存空间有较大要求；

(3) 分组交换

在报文交换的基础上，解决了“对结点的缓存空间有较高要求”的痛点；

分组限制了数据块的大小，将大的数据块划分为合理的小数据块；

**分组交换-数据报和虚电路**

(1) 数据报

数据报面向无连接；

中间结点存储分组，花费很短时间找到最佳路径后，就将分组转发出去；

不同的分组可以走不同的路径，可以以不同的顺序到达目标结点；

(2) 虚电路

虚电路面向有连接；

虚电路结合了数据报方式与电路交换，在发送分组前要求先建立一条虚电路，每个分组不需要有目标结点地址，并且保证每个分组正确且有序的到达；

## II. 传输介质

**双绞线**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210911215415352.png" alt="image-20210911215415352" style="zoom:50%;" />

最古老的传输介质，由两根并排的相互绞合的铜导线组成，外表还有金属丝编织成的金属网；

绞合与金属网的目的：提高抗电磁干扰能力；

带宽取决于铜线的粗细（正比）和传输的距离（反比）；

便宜，通常用于范围几千米内的局域网与传统电话网；

**同轴电缆**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210911220348980.png" alt="image-20210911220348980" style="zoom:50%;" />

按照阻抗的不同，可以分为：

(1) 50$\Omega$同轴电缆(基带同轴电缆) - 主要用于传输基带数字信号；

(2) 75$\Omega$​同轴电缆(宽带同轴电缆) - 主要用于有线电视系统；

由于多层的屏蔽，同轴电缆具有良好的抗干扰能力，常用于传输较高速率的数据；

**光纤**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210911221714647.png" alt="image-20210911221714647" style="zoom:30%;" />

光纤有高折射率的纤心和低折射率的包层构成，光线在较大入射角的情况下，碰到低折射率的包层，会发生全反射，这个过程不断重复，从而光纤沿着光纤传递下去；

由于材料的脆性和入射角度的要求，光纤不能大角度的弯折；

根据发光源和纤心粗细，光纤可以分为：

(1) 多模光纤

发光源为发光二极管，纤心较粗约为$50\mu m$，光线在多模光纤中传输时会失真，因此只适合短距离传输；

(2) 单模光纤

发光源为激光二极管，定向性很好，纤心较细约为$8\mu m$​，光线传输时衰减很小，适合远距离的传输；

**无线传输**

(1) 无线电波

具有较强穿透能力，能向所有方向散播不需要对准；如手机网络，无线局域网（WLAN）；

(2) 微波、红外线、激光

带宽高，需要发送方和接收方之间存在一条通路；

## III. 设备

### 1. 中继器

功能：信号经过一长段电缆的传输，因噪声等原因会有失真和衰减，中继器对信号进行整形再生，以使信号的波形和强度达到下一次传输的要求，从而延长信号传输距离；

中继器不能无限将信号传递下去，因为网络协议对信号的延迟有要求；

中继器只能放大数字信号（放大器可以放大模拟信号），没有存储转发功能，因此其两端的网络必须使用相同的协议；

### 2. 集线器

集线器相当于多个中继器的集合，其拥有多个端口，当接收到输入信号后，将信号整形再生后，转发到除输入端口的其他所有端口；

由于集线器只能半双工工作（端口不能同时读写），所以如果使用集线器组成共享式网络，网络的吞吐率会受限；



# 三、数据链路层

## I. 功能

**为网络层提供服务**

将源机器中来自网络层的数据传输到目标机器的网络层，可分为：

(1) 无确认的无连接服务

源机器发送数据帧不需要建立链路连接，目的机器收到数据帧不需要发回确认；

对丢失的帧不负责处理；

(2) 有确认的无连接服务

源机器发送数据帧不需要建立链路连接，目的机器收到数据帧必须发回确认；

对丢失的帧进行重传；

(3) 有确认的有连接服务

源机器发送数据帧时需要建立链路连接，目的机器对每一帧数据都需要发回确认；

对丢失的帧进行重传；

**链路管理**

对于有链接的服务，需要有建立链接$\to$传输帧$\to$释放链路，这一系列的操作称为链路管理；

**帧定界**

将一段数据的前后分别添加首部和尾部，就形成了数据帧，首部和尾部的一大作用即为给帧定界；

**帧同步**

接收方从接收到的二进制比特流中，根据首部和尾部区分出帧；

**透明传输与非透明传输**

首部和尾部用来给帧定界，但如果传输的数据中出现了和首部或尾部相同的字符，就会导致定界错误；

为避免该问题，对传输数据进行限制的传输称为非透明传输；

反之，通过特殊方法规避该问题，对传输数据没有任何限制的传输为透明传输；

**流量控制**

由于发送方和接收方的速度可能不同，而缓存空间有限，速度慢的一方会出现帧还没读取就被后来的帧挤占掉的情况，因此需要对发送方和接收方的速度进行协调，使发送速率不超过接收速率；

对于数据链路层来说，控制的是相邻两结点之间数据链路的流量；

**差错控制**

帧在传输过程中可能会因干扰出现错误，使接收方收到正确数据的方法即为差错控制；

错误可以分为：

(1) 位错 - 指帧中某些位出现错误；

纠错方法：自动重传请求法(ARQ) 

采用循环冗余检验法，发送方将数据帧与循环冗余检验码一起发出，接收方收到后根据校验码判断是否出错，若出错则丢弃；发送发迟迟收不到应答，则自动重传数据帧；

(2) 帧错 - 指帧丢失、重复、乱序；

纠错方法：引入定时器和编号机制；

## II. 组合成帧

### 1. 目的

出错时只需要重传特定的帧即可，不需要重传整个比特流；

### 2. 方法

组合成帧的方法主要需要解决帧定界、帧同步、透明传输的问题；

|                        | 说明                                                         | 优缺点                                                       |
| ---------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 字符技术法             | 在帧头部用一个计数字段表明该帧的字符数，从而给帧定界；       | 简单，但如果计数字段出错的话，将无法定界且影响后面的所有帧； |
| 字符填充的首位定界符法 | 使用特殊转义字符作为帧的起始符与终止符                       |                                                              |
| 比特填充的首位标志法   | 使用特殊的比特位组合作为帧的起始符与终止符，为了透明传输需要对数据进行修改以避免与标志位相同 | 性能优于字符填充法                                           |
| 违规编码法             | 对于曼彻斯特编码（高-低、低-高）来说，高-高和低-低为违规的编码，因此可以用来表示起始符和终止符 | 巧妙，常用                                                   |

## III. 差错控制

### 1. 噪声

噪声可以分为两类，

(1) 信道固有噪声，在信道中持续存在的随机热噪声，可以通过提高信噪比来避免；

(2) 外界冲击噪声，无法避免，是造成出错的主要原因；

### 2. 编码

#### 检错编码

对应自动重传请求法（ARQ），在有效数据发送前附加一些冗余编码，用以给接收端进行检错，如果发现错误，则通知发送端重传数据；

常见的检错编码有：

(1) **奇偶检验码**

最简单基础的检错编码，只需要1位（$n-1$位有效数据 + $1$位校验码）；

奇校验码 - $n$​位数据中$1$的个数位奇数；

偶校验码 - $n$位数据中$1$的个数为偶数；

(2) **循环冗余校验码CRC**

任何一个由二进制数位串组成的数据都可以与一个只含有$0$​和$1$​的多项式一一对应；

给定一个$m$位的有效数据，生成一个$r$​位的帧检验序列（FCS），最终发送的是$m+r$位的数据；

发送方和接收方事先约定一个多项式$G(x)$，使FCS恰好能被$G(x)$​整除；

接收方接收到FCS后，若不能整除，则认为出错；

计算方法：

$m$位有效数据对应的多项式为$M(x)$，将$M(x)$乘以$x^g$，即在$m$后加$g$个0，然后除以$G(x)$​，得到的余数为$R(x)$，$R(x)$对应的二进制数据即为$r$位的FCS；

分类：

一般以$G(x)$的阶数$g$来区分各个循环冗余算法，称为”CRC-g算法“；

#### 纠错编码

纠错编码能够使接收方收到错误的比特串时，根据纠错编码推导出正确的比特串；

常见的纠错编码有：

(1) **海明码**

海明码能够发现双比特错误，但只能纠正单比特错误；

Step 1：确定海明码的位数并按位插入有效数据中；

设有效数据有$m$位，海明码有$r$位，$r$位的海明码能够表示$2^r$个位置，因此需要满足
$$
2^r \geqslant m+r+1
$$
设有效数据为$1010110$共7位，则海明码需要$r=4$​，按位插入后总数据为
$$
r_1,r_2,1,r_3,0,1,0,r_4,1,1,0
$$
Step 2：分组，求出各个位置海明码的值；

海明码$r=4$​，需要分为4组，

| 二进制值 | 数据值 |
| -------- | ------ |
| 0001     | $r_1$  |
| 0010     | $r_2$  |
| 0011     | 1      |
| 0100     | $r_3$  |
| 0101     | 0      |
| 0110     | 1      |
| 0111     | 0      |
| 1000     | $r_4$  |
| 1001     | 1      |
| 1010     | 1      |
| 1011     | 0      |

其中，形如$XXX1$的分为第一组，$XX1X$的分为第二组，以此类推，

| 分组  | 组内成员        |
| ----- | --------------- |
| 第①组 | $r_1,1,0,0,1,0$ |
| 第②组 | $r_2,1,1,0,1,0$ |
| 第③组 | $r_3,0,1,0$     |
| 第④组 | $r_4,1,1,0$     |

要求同一组所有成员的异或值为0，从而求出$r_1=0,r_2=1,r_3=1,r_4=0$；

*异或：相等为0，不等为1*

Step 3：组合并发送；

Step 4：接收方分组并计算异或值，根据结果判断错误的位置；

如果结果没有出错，则得到的异或值组合为$0000$，说明没有错误；

如果存在错误，

(1) 有效数据出错

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210912204832660.png" alt="image-20210912204832660" style="zoom:50%;" />

$0,0,0,0,1,0\to 1$

$1,0,1,0,1,0\to 1$

   	  $1,0,1,0\to 0$

​		 $0,1,1,0\to 0$

得到的异或值组合为0011，表示第3位比特位出错；

(2) 校验码出错

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210912205643691.png" alt="image-20210912205643691" style="zoom:50%;" />

$0,1,0,0,1,0\to 0$​​

$1,1,1,0,1,0\to 0$​

   	  $0,0,1,0\to 1$​​

​		 $0,1,1,0\to 0$

得到的异或值组合为0100，表示第4位比特位出错；

## IV. 流量控制

### 1. 目的

控制发送速率，以使接收方有足够缓存空间接收每一帧；

### 2. 方法

#### 停止-等待法

每次只允许发送一帧；

发送方如果没有收到应答信号，则一直等待，当收到应答后才允许发送下一帧；

接收方每收到一阵都需要发送一个应答信号；

缺点：传输效率低下；

#### 滑动窗口法

发送方维持一组连续的允许发送的帧的序号队列，称为**发送窗口**，大小表示为$W_T$，代表在未收到应答信号的情况下最多允许发送的帧的数量；

接收方同样维持一组连续的允许接收的帧的序号队列，称为**接收窗口**，只有收到的帧的序号位于接收窗口内才进行接收，否则将帧丢弃；

发送窗口和接收窗口每处理一帧就向后移动一帧，因此称为滑动窗口；

对应滑动窗口的大小，有三种自动重传协议：

(1) **停止-等待协议**

当滑动窗口的大小为1时，滑动窗口法也就成了停止-等待法；

发送端设有一个计时器，如果超时没有得到应答信号，则自动重传上一帧（因此需要一个帧缓冲区存储发出的帧，当收到应答信号后才能清空帧缓冲区的内容）；

(2) **后退N帧协议**

接收方只允许按顺序接收；

发送方不是每次发送一帧，而是每次发送一组帧，接收方收到后会应答最后一个正确接收的帧的序号，发送方收到应答后会重发该序号之后的组内剩余的帧；

(3) **选择重传协议**

接收方可以乱序接收；

接收方怀疑帧出错后，会回传丢失或出错的帧的序号，发送方收到应答后重传指定的帧；

发送窗口与接收窗口大小相同，在帧不丢失或出错的情况下，所有帧都会乱序到达；

## V. 介质访问控制

数据链路层中有一个子层，称为介质访问控制（MAC，Medium Access Control），用来决定信道的分配；

### 1. 目的

采取一定的措施，为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号；

### 2. 方法

#### 信道划分

在发送端采用**多路复用**技术把多个输入通道的信息整合到一个通道中，在接收端把收到的信息分离出来并传送到对应的输出通道；

多路复用技术有：频分、时分、波分、码分；

#### 随机访问

又称“争用型协议”，信道不可共享，信息发送需要进行竞争，胜利者才能获得信道的使用权；

(1) **ALOHA协议**

① 纯ALOHA

当结点需要发送数据时，不需要检测直接发送，如果超时未收到确认信息，则认为发生了冲突，一段时间后重发；

② 时隙ALOHA

将时间划分为一段段等长的时隙，规定只能在时隙开始时发送数据；

避免了用户发送数据的随意性，提供了信道的利用率，吞吐量比纯ALOHA提高了一倍；

(2) **CSMA协议**

全名载波监听多路访问协议，每个站点在发送数据前，先侦听一下信道；

① 非坚持CSMA

如果侦听到信道空闲，则立即发送数据；

如果侦听到信道忙，则放弃监听，等待随机时间后再尝试发送；

② 1-坚持CSMA

如果侦听到信道空闲，则立即发送数据（发送概率为1，即100%）；

如果侦听到信道忙，则等待，并继续监听直到信道空闲；

③ p-坚持CSMA

如果侦听到信道空闲，则以概率p发送数据，以概率1-p推迟到下一个时隙；

如果侦听到信道忙，则下一个时隙再侦听；

(3) **CSMA/CD协议**

全名载波监听多路访问/碰撞检测协议；

传统的CSMA协议仍会存在冲突，如果两个站点同时侦听到空闲，则会同时发送数据产生冲突；

CSMA/CD相比传统的CSMA协议，增加了“边听边发”的功能：

​	如果侦听到信道忙，则继续监听直到信道空闲；

​	如果侦听到信道空闲，则发送数据，在发送过程中保持监听；

​	如果传输过程一直监听到空闲，则认为传输完成；如果监听到忙，则立即停止传输并发出一个拥塞信号；

​	若传输中止（或收到拥塞信号），则采用二进制指数退避算法随机等待一段时间后再次尝试发送；

(4) **CSMA/CA协议**

全名载波监听多路访问/碰撞避免协议；

CSMA/CD适用于有线连接的局域网，但无线连接的情况下，并非所有结点都互相可见，且无线信号衰减大，因此不能继续使用CSMA/CD协议；

CSMA/CA使用下列机制来实现碰撞避免：

① 预约信道

发送方在发送数据的同时向其他站点通知自己传输数据所需要的时间长度，在该段时间内其他站点不发送数据；

② ACK帧

规定接收方在正确接收到数据帧后需要向发送方应答一个ACK帧用以表示接收正确，发送方只有在收到ACK帧后才认为传输成功，否则重发数据；

③ RTS/CTS帧

用来解决站点之间不可见的问题；

#### 轮询访问

采用**令牌传递**协议；

设立一个监控站统一管理所有站点，以轮询的方式访问每个站点；

令牌在每个站点之间传递， 只有有令牌的站点才有发送数据的权力；



## VI. 局域网

### 1. 基本概念

局域网（LAN, Local Area Network）指在一个较小的地理范围内，将各种设备通过有线连接，组成资源共享的互联网络；

无线的局域网为WLAN；

局域网的特性主要由三个要素决定：

(1) **拓扑结构**

星形，环形，总线形，复合形；

(2) **传输介质**

双绞线，同轴电缆，光纤等；

(3) **介质控制方式**

CSMA/CA，令牌总线，令牌环等；

### 2. 拓扑实现

#### 以太网

以太网是目前使用范围最广的局域网，满足IEEE 802.3标准；

两项措施简化通信：

① 无连接；

② 不对发送的数据帧编号，也不要求接收方回复确认；（提供不可靠服务）



**以太网的一些规范**

(1) 传输介质

|                 | 编码     | 拓扑结构 | 最大长度 | 最多结点数 |
| --------------- | -------- | -------- | -------- | ---------- |
| 基带同轴电缆-粗 | 曼彻斯特 | 总线形   | 500 m    | 100        |
| 基带同轴电缆-细 | 曼彻斯特 | 总线形   | 185 m    | 30         |
| 非屏蔽双绞线    | 曼彻斯特 | 星形     | 100 m    | 2          |
| 光纤            | 曼彻斯特 | 点对点   | 2000 m   | 2          |

(2) 网卡

网卡是局域网中连接计算机和传输介质的接口，不仅实现与传输介质之间的物理连接和电信号匹配，还负责数据帧的发送和接收、帧的封装与拆分、介质访问控制等；

(3) MAC地址

每块网卡在出厂时都会被赋予一个唯一的代码，即MAC地址，用于控制主机在网络中的数据通信；

MAC地址由6位十六进制数字组成，其中高24为组织唯一标志符（OUI），为IEEE组织为不同厂商分配的代码；低24位为厂商自行分配的产品序列号；

(4) MAC帧

MAC帧是数据帧的一种，用于以太网中；

MAC帧的格式有两种标准：

① DIX Ethernet V2标准

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210916010138194.png" alt="image-20210916010138194" style="zoom:50%;" />

其中有效地址的最低长度要求是46 Byte，因为以太帧的最短帧长是64 Byte，减去源地址、目标地址、类型、FCS后最少还需要46 Byte才能满足要求；有效数据的最高长度为1500 Byte，为以太网的规定；

② IEEE 802.3标准

相比V2标准，802.3标准修改了帧定界符的格式，使其与802.4和802.5兼容；

并且使用长度域代替了类型域；



**高速以太网**

速率大等于100 Mb/s的以太网称为高速以太网；

|                  | 速率     | 传输介质 | 工作模式      | 协议           |
| ---------------- | -------- | -------- | ------------- | -------------- |
| 100-BASE-T以太网 | 100 Mb/s | 双绞线   | 全双工+半双工 | CSMA/CD        |
| 吉比特以太网     | 1 Gb/s   | 双绞线   | 全双工+半双工 | CSMA/CD        |
| 10吉比特以太网   | 10 Gb/s  | 光纤     | 全双工        | (全双工无冲突) |



#### IEEE 802.11

IEEE 802.11是无线局域网的一系列协议标准；

规定MAC层使用CSMA/CA协议进行介质访问控制；

分类：

(1) **有固定设施基础无线局域网**

802.11标准规定无线局域网的最小构建是**基本服务集**（BSS, Basic Service Set），一个基本服务集合包括一个基站和若干移动站；

BSS内部的站点之间可以直接通信，跨BSS的站点需要借助基站，基站也称**接入点**（AP, Access Point），其作用和网桥类似；

BSS可以是孤立的，也可以通过其AP接入一个主干分配系统，从而连接到其他BSS，多个BSS构成一个扩展服务集（ESS, Extended Service Set）;

(2) **无固定基础设施无线局域网自组织网络**

自组织网络没有AP等配套硬件设施，而是由一些移动站相互通信组成的临时网络；

各个站点之间都是平等的，网络中的结点可随意移动并能以任意方式相互通信；



#### 令牌环网

令牌环是一个环形网路结构，环中的每一个站点通过电缆与环接口的干线耦合器TCU相连；

**干线耦合器TCU**

功能：传递所经过的帧，为发送和接收数据提供接口；

状态：收听状态、发送状态；

工作机制：数据总是沿着某个特定的方向从上一个TCU到下一个TCU，每个TCU重新产生并传输每个比特数据；



令牌环中数据传递过程：

step 1: 当没有数据传输时，只有令牌帧在令牌环中循环传递；

step 2:当有站点需要发送数据且令牌帧恰好到达时，该站点在令牌帧中附加自己需要传递的数据，令牌帧就变成了数据帧；

step 3: 其他站点接收到数据帧时，查看数据帧的目的地址，如果是自己，则复制一份数据并转发数据帧；如果不是自己，则直接转发数据帧；

step 4: 数据帧继续沿着令牌环传递，直到回到源站点，源站点不再进行转发；

step 5: 重新产生一个令牌帧，进行下一次数据传输；



## VII. 广域网

### 1. 基本概念

广域网指的是覆盖范围很广（城市与城市之间）的长距离网络；

任务：远距离传输数据；

**与局域网的区别**

|          | 局域网                             | 广域网                                                       |
| -------- | ---------------------------------- | ------------------------------------------------------------ |
| 覆盖范围 | 通常在一个较小区域内，如公司、学校 | 较大，跨城市之间                                             |
| 连接方式 | 多点接入                           | 结点为点到点连接，但为了提高网络的可靠性，一个结点交换机通常与多个结点交换机相连接 |
| OSI层次  | 物理层+数据链路层                  | 物理层+数据链路层+网络层                                     |
| 着重点   | 数据传输                           | 资源共享                                                     |

### 2. 数据链路层协议

#### PPP协议

PPP协议即Point-to-Point Protocol，是使用串行线路进行点对点字节传输的协议；

PPP协议有三个组成部分：

(1) 链路控制协议

​	用来建立、测试、配置和管理数据链路；

(2) 网络控制协议

​	PPP协议允许使用多种网络层协议，每个不同的网络层协议都需要一个相应的网络控制协议，为网络层协议建立和配置连接；

(3) 将IP数据报封装进串行链路的方法

​	IP数据报即为PPP帧的消息部分；

**PPP帧**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210919191158116.png" alt="image-20210919191158116" style="zoom:50%;" />

信息部分的长度为0 Byte ~ 1500 Byte（PPP协议为点对点，不需要避免冲突，也就不需要采用CSMA/CD协议，因此没有帧最短长度的要求）；

#### HDLC协议

HDLC协议即为高速数据链路控制协议，是ISO制定的面向比特的数据链路层协议；

**特点**

① 传输比特，不依赖任何一种字符编码集；

② 采用“0比特插入法”，支持透明传输；

③ 全双工通信，有较高的数据链路传输率；

④ 所有帧采用CRC检验，并进行顺序编码，防止漏收与重发，可靠性高；

⑤ 控制与处理分离，灵活性高；

**站点分类**

(1) 主站

负责控制数据链路，发出的帧为“命令帧”；

(2) 从站

受控于主站，按主站的命令进行操作，发出的帧为“响应帧”；

(3) 复合站

可以是主站，也可以是从站；

**两种配置方式**

(1) 非平衡配置

一个主站控制整个链路；

(2) 平衡配置

链路两端都是复合站，可以平等地发起数据传输而不需要得到对方的允许；

**数据操作方式**

(1) 正常响应方式

适用于非平衡配置，主站向从站传输数据，从站得到主站的允许后进行响应；

(2) 异步平衡方式

适用于平衡配置，每个复合站都可以给对方传输数据；

(3) 异步响应方式

适用于非平衡配置，从站发送响应不需要得到主站的允许；

**HDLC帧**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210919191902729.png" alt="image-20210919191902729" style="zoom:50%;" />

**0比特插入法**

标志位为0x7E，即01111110，要保证透明传续需要防止信息部分中含有相同的数据，因此对信息部分进行检测，当碰到连续的5个1时在后面插入一个“0”，接收端接收时将插入的“0”删去，因此得名“0比特插入法”；

## VIII. 数据链路层设备

### 网桥

多个以太网通过网桥连接后，形成一个范围更大的以太网，原来的以太网被称为“网段”；

网桥相比于单传的转发器，具有过滤数据的能力，各网段相对独立，一个网段的故障不会影响到另一个网段；

**特点**

① 具备寻址能力和路径选择能力，能够确定帧的传输方向；

② 具备协议转换功能，能连接两个不同协议的网段；

③ 具有较大的缓冲空间；

**分类**

根据路径选择算法的不同，网桥可以分为：

(1) 透明网桥

以混杂方式工作，接收与之连接的所有LAN传输的每一帧，如果帧的源LAN与目的LAN相同，则**丢弃**该帧；如果不同，则**转发**该帧到目的LAN；如果目的LAN未指明，则**广播**该帧；

透明网桥还存在自学习机制，维护一个**转发表**，当网桥每收到一个帧，就记录下源地址和端口作为转发表的一个表项，下次转发到该地址时就使用记录下的端口；正因为该机制，透明网桥选择的路径往往不是最佳路由；

(2) 源路由网桥

源路由网桥中，路由选择由发送数据帧的源站点负责；

源站点找到最佳路由的方法：

源站点向目标站点广播一个**发现帧**，网桥转发发现帧并附加上自己的标记，由于存在多种路由路径，目标站点会多次接收到发现帧并一一回应应答帧，应答帧通过原来的路径返回到源站点，源站点收到应答帧后从中选出一个耗时最少的作为最佳路由；

找到最佳路由之后，源站点发送的数据帧的首部中就带有最佳路由的信息；

最佳路由不是距离最短的路径，而是耗时最少的路径，避开了某些因负荷太重和时延过长的网桥，从而实现了链路的负载均衡；

### 交换机

交换机检测收到的数据帧的源地址和目标地址，并与系统内部的动态查找表进行比较，若数据帧的地址不在动态查找表中，则将其加入表中，并将数据帧发给对应的目的端口；

**特点**

① 交换机的每个端口直接与主机连接，并且工作在全双工模式；

② 交换机能同时连接许多对端口，使每对相互通信的主机能无冲突地传输数据；

③ 类似透明网桥，自学习建立转发表；

④ 使用专门的交换结构芯片，交换速率较高；

**优点**

普通的共享式以太网，每个用户会平均地占用宽带，带宽总容量为$W$，每个人占用$\frac{W}{N}$；

而使用交换机时，每个用户是独占的，带宽总容量为$NW $，每个人占用$W$；

**交换模式**

交换机主要采用两种交换模式：

(1) 直通式

只检查帧的目的地址，交换机接收帧之后立即发送给目的地址，速度快，但缺乏智能性和安全性，无法支持具有不同速率的端口的交换；

(2) 存储转发式

接收到帧后，将帧缓存到高速缓存器中，并检查数据是否正确，如果正确，则通过查找表找到对应端口将帧发送出去；如果不正确，则丢弃帧；

该交换模式可靠性高，支持不同速率端口之间的转换，但延迟较高；



# 四、网络层

## I. 功能

1、将不同类型的网络互连

网络层统一使用标准化协议，但相互连接的网络可以是异构的；

2、路由与转发

路由表：根据路由算法得到；

转发表：根据路由表得到；

3、拥塞控制

拥塞现象：网络负载过重，数据来不及处理，时延过长导致后续数据被丢弃；

控制方法：

(1) 开环控制

事先考虑到所有会导致拥塞的因素，避免拥塞现象的产生；

(2) 闭环控制

采用监测网络系统去监视是否产生拥塞，然后及时调整网络的运行；

## II. 路由算法

|              | 优点         | 缺点               |
| ------------ | ------------ | ------------------ |
| 静态路由算法 | 简单，可靠   | 不灵活             |
| 动态路由算法 | 能够动态调节 | 复杂，增加网络负担 |

### 静态路由算法

又称非自适应路由算法，指由网络管理员手动配置路由信息，一般只适合小型且不变动的网络环境；

### 动态路由算法

又称自适应路由算法，指路由器上的路由表项是通过相互连接的路由器之间彼此交换信息、然后按照一定的算法优化得到；这些表项会随时间不断更新，以随时获得最佳的寻路路径；

常用的动态路由算法有：

(1) **距离-向量路由算法**

迭代计算一条路由中的段数或延迟时间，从而得到一个达到目标地址的最短路径；

所有结点定期地将它们的目的地和距离传送给所有与其直接相邻的结点，当发现一条新的路由或发现更短的路径时，结点会更新自己的路由选择表；

典型的距离-向量路由算法是RIP路由算法，其使用跳数（经过的路由的个数）作为距离的度量；

(2) **链路状态路由算法**

要求每个参与该算法的结点都具有完全相同的网络拓扑结构，它们需要：

step 1: 主动测试所有邻接结点（同一条链路上的结点）的状态；

step 2: 定期将链路状态传播给所有其他结点；

典型的链路状态路由算法为OSPF算法；

### 层次路由

扁平化的网络是不可取的，因为随着网络规模的增大，路由表会成比例增大，导致寻址时间增加；

因此，层次路由将整个互联网分为许多较小的自治系统，每个自治系统有权决定使用哪种路由选择协议（称为“域内路由选择”，如RIP、OSPF），不同的自治系统之间的通信需要借助中间层协议（称为“域间路由选择”，如BGP）；

在一个自治系统之内，再将其划分为多个区域，从而实现路由的分层；

## III. IPv4

### 1. 分组格式

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210920192125917.png" alt="image-20210920192125917" style="zoom:50%;" />

版本 - 若为IPv4，则版本号为4；

首部长度 - 一般为20 Byte（默认值）；

总长度 - 下层数据链路层以太帧的最大传输长度为1500 Byte，因此IP报的总长度不能超过该值；

标识 - 当总长度超过1500 Byte时需要将IP报分片，标识号用来把被分片的数据正确组装，

​			同一组的分片的标识号相同；

标志 - 共3位，第一位未定义；第二位为MF，MF=1表示后面还有分片，MF=0表示是最后一个分片；

​			第三位为DF，DF=0时表示允许分片

片偏移 - 该分片在原数据报中的相对位置；

首部校验和 - 只校验首部，不校验数据部分；

生存时间(TTL) - 该数据报在网络中可通过的路由器数量的最大值，确保该数据报不会一直循环发送；

​							每经过一个路由器，TTL-1，当TTL=0时丢弃；

协议 - 表示传输层使用的协议，6表示TCP，17表示UDP；

源地址/目标地址 - 指IP地址；

### 2. 分片

一个数据链路层能承载的最大数据量称为最大传送单元(MTU)，当IP数据报的长度超过MTU时需要分片；

通过标识+片偏移来组合分片；

### 3. IPv4地址

一个32 bit的全球唯一标识符（目前已接近枯竭）；

分为A~E共五类：

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210920194644615.png" alt="image-20210920194644615" style="zoom:50%;" />

组成：

IP地址通常由网络号（表示连接的唯一的网络）和主机号（表示网络内唯一的主机）组成；

特殊的IP地址：

① 主机号为0的表示该网络本身；

② 主机号为255的为该网段的广播地址；

③ 127.0.0.1表示环路自检地址，表示主机本身；

④ 0.0.0.0表示本机的所有IPv4地址；

⑤ 255.255.255.255表示整个TCP/IP网络的广播地址，实际使用时，由于路由器的隔离，相当于主机所在网络的广播地址；

### 4. 地址转换NAT

将内部私有IP地址转为公用IP地址；

作用：

① 由于私有IP地址是可以重用的，所以NAT大大节省了IP地址的消耗；

② 隐藏内部网络结构，降低内部网络收到攻击的风险；

**私有IP地址**

A类：10.0.0.0~10.255.255.255；

B类：172.16.0.0~172.31.255.255；

C类：192.168.0.0~192.168.255.255；

私有IP地址也称可重用地址，不同主机的私有IP地址可能相同；

数据报的目的地址如果是私有IP地址，则不允许转发；

**NAT转换表**

使用私有IP地址的主机与外界通信时，NAT路由器使用NAT转换表将私有IP地址转为全球地址，或将全球地址转为私有IP地址；

NAT转换表中存放着{本地IP地址:端口}到{全球IP地址:端口}，通过这种方式（区分端口），可以让多个私有IP地址映射到同一个全球地址；

比如，一个宽带服务被运营商分配的全球地址为138.76.29.7，私有地址为192.168.0.0网段，则NAT转换表为

| LAN               | WAN               |
| ----------------- | ----------------- |
| 192.168.0.1: 2233 | 138.76.29.7: 5001 |
| 192.168.0.3: 3300 | 138.76.29.7: 6060 |
| ...               | ...               |

**工作机制**

普通路由器在转发IP数据报时，不改变其源IP地址和目标IP地址；

NAT路由器在转发IP数据报时，转换源IP地址为公用地址；

### 5. 子网划分

将IP地址划分为两级，但地址空间利用率还是很低，于是又增加了子网号字段，现在的IP地址格式为

{网络号, 子网号, 主机号}；

**子网掩码**

为了告知路由器对一个网络地址进行了子网划分，使用子网掩码来表达对原网络地址中主机号的借位；

IP地址 & 子网掩码 = 所在子网地址；

比如将192.168.1.0~192.168.1.255划分为4个子网，分别是

```
192.168.1.0   ~ 192.168.1.63
192.168.1.64  ~ 192.168.1.127
192.168.1.128 ~ 192.168.1.191
192.168.1.192 ~ 192.168.1.255
```

观察第一个子网，

```
192.168.1.0   -> 192.168.1.00000000
192.168.1.63  -> 192.168.1.00111111
```

处于该子网内的地址，其前26位相同，因此可以将该网段表示为192.168.1.0/26；

依次类推，4个子网分别是

```
192.168.1.0/26
192.168.1.64/26
192.168.1.128/26
192.168.1.192/26
```

对应的子网掩码为

```
11111111,11111111,11111111,11000000 -> 255,255,255,192
```

对于一个IP地址如192.168.1.150，将其“与”上子网掩码，得到192.168.1.128，即为该IP的子网地址；

**无分类域间路由选择 CIDR**

CIDR是在变长子网掩码的基础上提出的一种消除传统A、B、C类网络划分、可以在软件的支持下实现超网构造的一种IP地址划分方法；

优点：网络前缀长度选择灵活，方便划分子网；

### 6. 协议

**地址解析协议 ARP**

ARP负责IP地址到MAC地址的映射；

每台主机都有一个ARP高速缓存，用来存放本局域网内各主机和路由器的IP地址到MAC地址的映射表，称为ARP表；

ARP属于网络层协议；

工作机制：

step 1：收到一个IP数据报，解析其目的IP地址，在ARP表中查找；

step 2：如果找到对应MAC地址，则将该MAC地址附加到MAC帧中，通过局域网发送MAC帧；

step 3：如果未找到，则将目标地址定为FF-FF-FF-FF-FF-FF写入MAC帧并广播，同一个局域网内的所有主机都会收到该帧，目标地址符合的主机会回传一个响应，发送方主机收到响应后记录下IP地址与MAC地址的映射关系；

step 4：如果未收到响应，则说明目标主机不在当前局域网内，则将分组发给路由器，路由器转发给下一个网络；

**动态主机配置协议 DHCP**

常用于给主机动态地分配IP地址，允许一台新计算机加入网络并获取IP，而不需要用户手动配置；

DHCP服务器与客户端的通信基于UDP；

DHCP属于应用层协议；

工作机制：

step 1：需要IP地址的主机在启动时广播发送“发现报文”；

step 2：当DHCP服务器收到“发现报文”后，在其数据库中查找该主机的配置信息，若找到，则从数据库中取出IP地址；若找不到，则从IP地址池中取一个地址；将找到的地址以“提供报文”的形式广播给请求方主机；

DHCP服务器可以有多个，主机收到多个提供报文后，通常选择最先收到的；

**网际控制报文协议 ICMP**

ICMP让主机和路由器报告差错和异常情况，以提高IP数据报的成功交付率；

ICMP属于网络层协议；

(1) **ICMP差错报告报文**

用于目标主机或路径上的路由器向源主机报告差错和异常情况；

可分为：

① 终点不可到达报文；

② 源点抑制报文 - 由于拥塞而不能交付数据报；

③ 超时报文 - 丢弃TTL=0的数据报同时发送；

④ 参数错误报文 - 目的主机收到的数据报的首部中有的字段有错误；

⑤ 重定向报文 - 有更好的路径选择时；

不应该发送ICMP差错报告报文的情况：

① 传输的数据报就是ICMP差错报告报文；

② 传输的数据报是分片的、且不是第一片；

③ 传输的数据报是广播或组播的

④ 传输的数据报的地址为特殊地址（127.0.0.1或0.0.0.0）；

(2) **ICMP询问报文**

可分为：

① 回送请求与回答报文；

② 时间戳请求与回答报文；

③ 掩码地址请求与回答报文；

④ 路由器询问与回答报文；

探测IP地址是否可以访问的`ping`命令即是ICMP回送请求与回答报文的应用；



## IV. IPv6

### 1. 目的

IPv4地址日益减少，解决措施有以下几种：

(1) 使用CIDR更合理地分配IPv4；

(2) 使用NAT复用IPv4；

(3) 使用IPv6替代IPv4；

前两种都是治标不治本，只有使用IPv6才能根本上解决问题；

### 2. 相比IPv4优点

① IPv4的地址长的多，几乎不可能被用完；

② 简化了IP数据报头（去掉总长度、校验和、片偏移等字段），提高了路由器的效率，提高了网络的吞吐率；

### 3. IPv6地址

**类型**

(1) 单播 - 传统的点对点通信；

(2) 组播 - 一对多通信；

(3) 任播 - IPv6特有的通信类型，地址为一组计算机，但数据报只会交付给组中距离最近的那台计算机；

**表示方法**

使用冒号分隔连续的4位十六进制数字；

```
全写：4BF5:0000:0000:0000:BA5F:039A:000A:2176

缩写1：4BF5:0:0:0:BA5F:39A:A:2176 (省略前面的0)

缩写2：4BF5::BA5F:39A:A:2176 (双冒号最多出现一次)
```

## V. 路由协议

### 1. 自治系统

自治系统（AS, Autonomous System）为单一技术管理下的一组路由器，一个自治系统内的所有路由器都是连通的，使用内部自己的路由协议进行管理；AS之间的通信则需要借助域间路由选择；

### 2. 内部网关协议

即域内路由选择，为一个AS内部使用的路由选择协议，与其他AS内部的协议互不影响；

#### RIP协议

路由信息协议（RIP, Routing Information Protocol）是一种分布式的基于距离-向量路由选择算法的路由选择协议，内部网关协议中最先得到广泛应用的协议；

RIP属于应用层协议，在传输层使用UDP进行通信；

**跳数**

规定从一个路由器到另一个路由器的距离为1个跳数，RIP中将跳数作为路由距离的度量单位；

**特点**

① 网络中的每个路由器都要维护自身到每个目的网络的距离记录；

② 规定一条网络路径最多包含15个路由器，即跳数最大值为15，超过15则认为网络不可达；

③ 任意两个使用RIP的路由器之间每30秒广播一次RIP路由更新信息，以进行动态维护；

**工作机制**

step 1: 收到相邻路由器发来的路由表后，如果自己的表中没有某个目的网络，则加入；如果有且跳数更小，则替换；如果有且跳数相等或更大，则无视；

step 2: 如果超过180s未收到相邻路由器的RIP路由，则认为该路由器不可达，将跳数设为16；

**优点**

实现简单，仅需几次广播就可以收敛；

**缺点**

① 要求的网络规模小，最多路由器不超过15个；

② 路由器之间交换的是完整的路由表，开销大；

③ 跳数最短的路由不一定是耗时最少的路由；

#### OSPF协议

开放最短路径优先协议（OSPF）是一种分布式的基于链路状态路由算法的路由选择协议；

OSPF属于网络层协议，使用IP数据报通信；

**工作机制**

各路由器之间频繁地交换链路状态信息，最终所有路由器都能建立一个链路状态数据库，然后每个路由器根据这个数据库，使用Dijkstra最短路径算法计算自己到各个目的网络的最优路径，以此构造自己的路由表；

**与RIP的比较**

|                    | RIP协议           | OSPF协议                           |
| ------------------ | ----------------- | ---------------------------------- |
| 算法               | 距离-向量路由算法 | 链路状态路由算法                   |
| 度量标准           | 跳数              | 链路耗时                           |
| 工作层次与传输方法 | 应用层 + UDP      | 网络层 + IP数据报                  |
| 适用性             | 小规模网络        | 大规模网络                         |
| 广播对象           | 相邻路由器        | 本AS内的所有其他路由器             |
| 广播数据结构       | 整个路由表        | 自身与其他相邻路由器之间的链路状态 |

### 3. 边界网关协议

边界网关协议（BGP）即域间路由协议，是不同自治系统的路由器之间交换路由信息的协议；

边界网关协议是应用层协议，传输层使用TCP通信；

**寻路策略**

由于域间传输距离长、时延高，寻找最佳路由不显示，因此BGP的目标是找到一条能用的路由；

**工作机制**

step 1: 每个AS的管理员选择至少一个路由器作为”BGP发言人“；

step 2: BGP发言人之间建立TCP连接并交换路由信息；

step 3: 首次交流交换整个路由表，之后的交流只交换变化的部分即可；

step 4: 根据交换的信息建立BGP路由表；

**报文类型**

(1) Open报文 - 用来与另一个BGP发言人建立关系；

(2) Update报文

(3) KeepAlive报文

(4) Notification报文 - 用来发送检测到的差错；



## VI. IP组播

IP组播指的不是让源主机给每个目的主机都发送一遍数据，而是让源主机将数据发给一个组播地址，该组播地址标识一组地址，组内的目标主机都可以收到数据；

组播使用UDP，不保证可靠交付；

### 1. 组播地址

IP组播地址使用D类地址格式，前四位固定为1110，因此范围为224.0.0.0~239.255.255.255；

**特点**

① 组播地址只能用于目的地址而不能用于源地址；

② 并非所有D类地址都可以作为组播地址；

③ 组播数据报不产生ICMP差错报文，因此`ping`组播地址不会有响应；

D类地址不能全部用作组播地址，是因为D类地址与以太网组播MAC地址的映射关系不唯一：

​	以太网组播地址的范围是01-00-5E-00-00-00 ~ 01-00-5E-7F-FF-FF，共23位可用；

​	D类地址的范围是224.0.0.0~239.255.255.255，共28位可用；

​	因此，主机收到IP组播数据报后，还要再IP层进行筛选；

### 2. 因特网组管理协议

因特网组管理协议（IGMP, Internet Group Management Protocol）负责协同因特网上各个组播路由器的工作，以便把组播数据用最小代价传送给所有组成员；

**工作机制**

step 1: 当某主机新加入组播组时，该主机发送一个IGMP报文到组播地址，组播路由器收到IGMP报文后，转发给因特网上的其他组播路由器；

step 2: 组播路由器周期性地试探本地局域网内的主机，如果多次没有任何主机回应，则不再将该组的成员关系信息转发给其他组播路由器；



## VII. 移动IP

移动IP是为了满足移动结点在移动中保持连接而设计的，保证移动结点以固定的IP地址实现跨越不同网段的漫游功能；

**移动结点**

具有永久IP地址且会移动的结点；

**本地代理**

一个移动结点的永久居所称为归属网络，在归属网络中代表移动结点执行移动管理功能的实体称为本地代理（也叫归属代理）；本地代理根据移动用户的转交地址，采用隧道技术转交移动结点的数据包；

**外部代理**

对应于本地代理，在外部网络中代表移动结点执行移动管理功能的实体称为外部代理；

### 1. 通信过程

① 移动结点在本地网络中时，按照传统的TCP/IP方式进行通信；

② 移动结点漫游到外地网络中时，IP不变，移动结点向本地代理注册当前的位置地址作为**转交地址**；

③ 本地代理接收到转交地址的注册后，构建一条通往转交地址的**隧道**，截获原先发给移动IP的分组，将数据通过隧道发向转交地址；

④ 在转交地址处，将收到的数据解除隧道封装，传给移动结点；

出国或跨省后使用的是外部代理，过程类似；



# 五、传输层

## I. 功能

对比网络层：

① 网络层为主机之间提供逻辑通信，而传输层为应用进程之间提供逻辑通信；

② 网络层只检查IP数据报的首部，而传输层需要检测报文的首部和数据部分；

③ 网络层或者提供面向连接的服务（虚电路），或者提供无连接的服务（数据报），而传输层可同时提供有连接和无连接的服务（TCP/UDP）；

## II. 基本概念

**端口**

端口是传输层服务的访问点，端口之于传输层，相当于IP地址之于网络层、MAC地址之于数据链路层；

应用进程通过端口将数据交付给传输层，同样根据端口决定数据将被交付给哪个进程；

**端口号**

应用进程通过端口号进行标识，端口号长度为16 bit，能够标识65535个不同的进程；

端口号是虚拟的概念，只在本地具有意义；

(1) 服务器端的端口号

其中0~1023为特殊端口号，这些端口号被指派给TCP/IP中的最重要的一些程序，不可以占用；

1024~49151为登记端口号，使用这些端口号需要在IANA机构登记，防止重复；

(2) 客户端的端口号

49152~65535，称为临时端口号，程序运行时占用，停止运行后释放；

**套接字**

套接字表示一个通信端点，套接字 = （IP地址 + 端口号），用来唯一地标识某个主机上的某个应用进程；

## III. UDP

UDP在IP数据报的基础上仅仅增加了1. 复用分用 和 2. 差错检测 功能；

### 1. 优点

① 无需建立连接，速度快；

② 无连接状态，支持更多的客户端；

③ 首部仅有8 Byte，开销小；

④ 能很好地控制要发送的数据和发送时间；

### 2. 应用

常用于一次性传输较少数据的网络应用，如DNS，SNMP；

以及多媒体应用（可以丢包，但不能时延太长），如视频会议、流媒体等；

### 3. 首部格式

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210923022929583.png" alt="image-20210923022929583" style="zoom:50%;" />

源端口号 - 需要对方回传信息时选用，不需要时为0；

目的端口；

UDP长度：首部+有效数据的长度，最短为8 Byte（无数据时）；

UDP校验和：选用，不需要时为0；

### 4. UDP校验

计算校验和时，需要在UDP数据报之前增加12 Byte的”伪首部“，伪首部不传送，只用来产生校验和；

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210923024426310.png" alt="image-20210923024426310" style="zoom:50%;" />

## IV. TCP

### 1. 特点

① 面向连接；

② 点对点，只能有两个端点；

③ 保证传送的数据无差错、不丢失、不重复、有序；

④ 全双工通信，两端都有发送缓存和接收缓存；

⑤ 面向字节流；

### 2. 首部格式

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210923030115106.png" alt="image-20210923030115106" style="zoom:50%;" />

序号 - 本报文段所发送数据的第一个字节的序号；

确认号 - 期望收到对方的写一个报文段的数据的第一个字节的序号，若为N，则表示之前N-1个字节都收到了；

数据偏移 - 指TCP报文段的数据部分距离TCP报文段起始处的偏移；

保留字段 - 暂时保留；

紧急位URG - 为1时表示有紧急数据应尽快传送；

确认位ACK - 规定连接建立后所有传送的报文段的确认位都为1；

推送位PSH - 为1时表示该报文段应尽快交付而不再等待整个接收缓存填满；

复位位RST - 位1时表示该TCP连接中出现严重错误，需要断开连接后重连；

同步位SYN - 当SYN=1，ACK=0时，表示这是一个请求连接的报文；

​						当SYN=1，ACK=1时，表示这是一个同意连接的报文；

终止位FIN - 为1时表示这是一个请求断开连接的报文；

窗口 - 表示允许对方发送的数据量；

检验和  - 同样需要12 Byte的伪首部；

紧急指针 - 配合紧急位URG使用，指出本报文段的数据中紧急数据为前多少个字节；

选项 - 可规定数据字段的最大长度等；

填充 - 保证整个首部的长度为4 Byte的整数倍；

### 3. 连接管理

TCP连接分为三个阶段：建立连接 + 数据传送 + 断开连接；

**建立连接**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210923034534229.png" alt="image-20210923034534229" style="zoom:50%;" />

服务器段的资源在第二次握手时分配，而客户端的资源在第三次握手时分配，这就导致服务器段会受到SYN洪泛攻击；

为什么需要三次握手而不是两次：防止（因超时等原因导致的）已失效的请求报文到达服务器端；

**断开连接**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210923035151484.png" alt="image-20210923035151484" style="zoom:50%;" />

值得注意的是，客户端最后发送ACK报文后，需要等待2 MSL（报文最长生存时间）的时间才关闭，原因是：

(1) 防止因ACK报文都是而导致客户端关闭而服务器端未关闭；

(2) 保证本次连接持续时间内所产生的所有报文段从网络中消失，防止已失效的请求连接到达服务器端；

### 4. 可靠传输

TCP为了保证可靠传输，使用了以下机制：

**序号**

TCP将数据看作一个无结构但有序的字节流，序号依附于字节而不是报文段；

通过序号来保证数据的有序性；

**确认号**

确认号表示希望下一次收到的报文段的序号；

**重传**

有两种情况TCP会对报文段进行重传：

(1) 超时

TCP每发送一个报文段，就对这个报文段设置一次计时器，当超时未收到确认时，重传该报文段；

(2) 冗余ACK

冗余ACK即发送重复的应答报文，比如发送了序号为1、2、3的报文段，其中2、3遗失或损坏了，则接收方会返回3个ACK=1的报文段，从而触发重传；

### 5. 流量控制

TCP需要流量控制功能来消除发送方使接收方缓存区移除的可能性，流量控制功能基于滑动窗口协议；

在通信过程中，接收方根据自己的接收缓存的大小，修改TCP报文段首部的“窗口”字段，从而动态调整发送方的窗口大小，称为**接收窗口rwnd**；同时，发送方根据对当前网络拥塞状况的估计而确定一个窗口值，称为**拥塞窗口cwnd**，其大小与网络的带宽与延迟相关；

发送方实际的发送窗口大小取rwnd和cwnd之间的较小值；

**与数据链路层窗口机制的区别**

① 传输层窗口控制的是端对端之间的传输，而数据链路层窗口控制的是结点之间的传输；

② 传输层窗口大小可以动态调整，而数据链路层窗口大小是固定的；

### 6. 拥塞控制

拥塞控制，指防止过多的数据流入网络，导致路由器或者链路过载；

拥塞控制类似于流量控制，都是通过限制发送方的发送速率来进行控制；

拥塞控制算法：

(1) **慢开始 + 拥塞避免**

当TCP刚连接好发送报文段时，设置cwnd=1，此后，每收到一个ACK，则cwnd+1；

同时设置一个cwnd阈值，当cwnd的值达到慢开始阈值时，改用拥塞避免算法；

慢开始是每收到一个ACK则cwnd+1，而拥塞避免是每经过一个往返则cwnd+1（限制cwnd的增长速度）；

当检测到一次超时时，则令慢开始阈值为当前cwnd的一半，并重新将cwnd置为1；

当cwnd < 慢开始阈值，使用慢开始算法，cwnd指数增长；

当cwnd > 慢开始阈值，使用拥塞避免算法，cwnd线性增长；

(3) **快重传 + 快恢复**

对于触发重传的机制，有超时和冗余ACK，快重传对其做出改进，当收到冗余ACK时直接重传，不需要等待超时；

快恢复则是，当连续收到三个冗余ACK时，将慢开始阈值置为当前cwnd的一半，并令cwnd=慢开始阈值，由于cwnd跳过了从1到慢开始阈值的步骤，因此称为“快恢复”；

# 六、应用层

## I. 应用层模型

### 1. C/S模型

即客户端/服务器端模型；

常见的CS模型的应用：Web服务，文件传输协议FTP，远程登陆，电子邮件等；

**特点**

① 可以赋予各个客户端不同的权限，方便管理；

② 客户端相互之间无法之间通信，需要借助服务器；

③ 受硬件和网络带宽的限制，能连接的客户端数量有限；

### 2. P2P模型

即Point-to-Point，用户对用户模型；

P2P模型中，每个结点都具有平等的功能和权限，结点之间可以之间通信；

常见的P2P模型的应用：PPlive，bittorrent等；

**特点**

① 不依赖某个特定的服务器，可以将任务分配到多个结点上，大大提高了资源利用率；

② 可拓展性与网络健壮性好；

③ 占用内存与网络带宽较多；

## II. 域名系统

域名系统（DNS）是因特网的命名系统，负责将域名转为IP地址；

DNS通常使用CS模型，使用UDP传输，使用53号端口；

DNS可分为三部分：层次域名空间、域名服务器、解析器；

### 1. 层次域名空间

域名可被划分为多个层次，使用`.`分隔，从左到右级别依次增高；

如`www.baidu.com`，其中`com`为顶级域名，`baidu`为二级域名，`www`为三级域名；

顶级域名可分为：

(1) 国家顶级域名（nTLD，national TLD）

表示国家或地区，如`.cn`表示中国，`.us`表示美国，`.hk`表示香港；

(2) 通用顶级域名（gTLD，global TLD）

如`.com`表示公司，`.net`表示网络服务机构，`.org`表示非盈利组织，`.gov`表示政府部门；

(3) 基础结构域名

当前只有`.arpa`，用于反向域名解析；

### 2. 域名服务器

域名系统被设计成一个联机分布式的数据库系统，采用CS模型；

域名到IP地址的解析由运行在域名服务器上的程序完成，一个域名服务器管理一个“区”，区内的所有结点必须是能够连通的，并且域名服务器之间也需要连通；

域名服务器可分为四层：

(1) **根域名服务器**

根域名服务器是最高层次的域名服务器，所有根域名服务器都知道所有顶级域名服务器的IP地址；

根域名服务器共有13台，大部分都在美国；

不管是那个本地域名服务器，如果自己无法解析，都会首先求助于根域名服务器；更域名服务器通常不直接把域名转为IP地址，而是告诉本地域名服务器下一步应该找哪个顶级域名服务器进行查询；

(2) **顶级域名服务器**

顶级域名服务器负责管理其注册的所有二级域名，收到DNS查询请求后，给出IP地址或下一步应当查找的服务器的地址；

(3) **权限域名服务器**

每个需要联网的主机都需要在一个或多个权限域名服务器进行注册，权限域名服务器总能将其管辖的主机名转为对应的IP地址；

(4) **本地域名服务器**

每个区域内都有一台本地域名服务器，当区域内的某台主机发出DNS查询请求时，该请求报文都会发给该区域内的本地域名服务器；

系统中配置的DNS地址，值的就是本地域名服务器的地址；

### 3. 解析器

域名解析是指把域名映射成IP地址（正向解析）或把IP地址映射成域名（反向解析）；

**解析步骤**

当需要域名解析时，主机的DNS客户端会构造一个DNS请求报文，以UDP数据报的方式发往本地域名服务器；

**解析方式**

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210925105434000.png" alt="image-20210925105434000" style="zoom:50%;" />

递归方式对根域名服务器的负载过大，通常采用递归+迭代的方式（主机与本地域名服务器之间是递归，本地域名服务器与其他域名服务器之间是迭代）；

## III. 文件传输协议FTP

FTP是当前使用最广泛的文件传输协议，采用CS模式，使用TCP传输；

一个FTP服务器可同时为多个客户端提供服务，FTP服务器进程可分为主进程（负责接收新的请求）和若干从属进程（负责处理单个请求）；

### 1. 功能

① 提供不同种类主机系统之间的文件传输能力；

② 以用户权限管理的方式提供用户对远程FTP服务器上的文件管理能力；

③ 以匿名FTP的方式提供公用文件共享的能力；

### 2. 工作步骤

step 1: 打开控制端口，使客户端能够连接上；

step 2: 等待客户端发起请求；

step 3: 接收到请求后，启动从属进程处理请求，处理完成后从属进程终止；

step 4: 继续等待客户端请求；

### 3. 工作机制

FTP工作时使用两个并行的TCP连接，一个是控制连接（端口21），另一个是数据连接（端口20）；

**控制连接** 

监听21号端口，等待请求，建立的连接为控制连接，负责在传输过程中控制数据连接，因此在整个会话期间一直保持打开状态；

**数据连接**

数据连接负责连接客户端和服务器端的数据传输进程，传输完毕后关闭；

## IV. 电子邮件

电子邮件是一种异步通信方式，不需要双方同时在场；

一个电子邮件系统包含三个主要组件：用户代理、邮件服务器、邮件协议；

**用户代理**

用户与电子邮件系统的接口，使用户能够通过一个很友好的接口发送和接收邮件；

通常用户代理指的就是运行在PC上的邮件程序，如Outlook、Foxmail等；

**邮件服务器**

负责发送与接收邮件，并向用户发送邮件的实时状态；

**邮件协议**

通常有SMTP协议、POP3协议等；

### 1. 工作步骤

step 1: 发送方调用用户代理编辑并发送邮件，用户代理使用SMTP协议把邮件发给发送方邮件服务器；

step 2: 发送方邮件服务器将邮件放入邮件缓存队列，等待发送；

step 3: 发送方邮件服务器上运行着的SMTP客户进程发现缓存队列中有待发送的邮件，于是向接收方邮件服务器上的SMTP服务器进程发起TCP连接；

step 4: TCP连接建立后，开始发送邮件；发送完成后，TCP连接断开；

step 5: SMTP服务器进程收到邮件后，将邮件放入用户邮箱；

step 6: 接收方打算收信时，通过用户代理使用POP3协议从接收方邮件服务器的用户邮箱中将邮件取出；

### 2. 格式

电子邮件分为信封和内容，而内容又分为首部和主体；

首部：

```
From:XXX@Foxmail.com(一般自动填写)
To:XXX@qq.com
Subject:Hello...
```

用户填写好首部后，邮件系统自动地将所需信息提取出来并写在信封上；

### 3. MIME

SMTP只能传送一定长度的ASCII码，许多非英文的字符或二进制文件无法传送，因此出现了MIME；

MIME增加了邮件主体的结构，定义了传送非ASCII码的规则，可以在现有电子邮件程序和协议下使用；

### 4. SMTP与POP3

**SMTP**

简单邮件传输协议（SMTP）是一种提供可靠且有效的电子邮件传输的协议，能够控制两个相互通信的SMTP进程交换信息；

SMTP使用TCP连接，端口号为25；

(1) 建立连接

SMTP客户端每隔一定时间对邮件缓存扫描一次，若发现待发送邮件，则使用25号端口与SMTP服务器端建立连接，连接建立后接收方发送220 Service Ready表示能够接收邮件；

(2) 邮件传送

```
C: HELO {hostname}
S: 250 ok
C: MAIL FROM {address}
S: 250 ok
C: RCPT TO {address}
S: 250 ok / 550 No such user here
C: DATA
S: 354 Start mail input;end with <CRLF><CRLF>
......
```

(3) 连接释放

邮件发送完成后，SMTP客户端发送`QUIT`命令，SMTP服务器返回`221 Service close`，连接关闭；

**POP3**

邮局协议（POP3）采用“拉”的方式获取邮件；

POP3使用TCP连接，端口号为110；

### 5. IMAP与HTTP

IMAP是一种更精细复杂的邮件接收协议（对位POP3），但目前尚未广泛使用；

有很多基于万维网的电子邮件如Hotmail、Gmail，使用HTTP协议发送与接收邮件，仅在不同邮件服务器之间传送邮件时才使用SMTP；

## V. 万维网WWW

万维网是一个资料空间，其中每个事物都可被看作资源，通过url表示，并通过http传送给使用者；

万维网的三个标准：

(1) 统一资源定位符 URL

负责表示万维网上的各种资源，具有唯一性；

(2) 超文本传输协议 HTTP

使用TCP进行传输，是万维网客户端与服务器端之间交互时必须遵循的协议；

(3) 超文本标记语言 HTML

使用一些约定的标记对页面上的各种信息进行描述；

### 1. HTTP

超文本传输协议（HTTP）是一种面向事务的应用层协议，规定了请求与响应的格式，是万维网资源互传的基础；

**工作机制**

每个万维网站点都有一个服务器进程，不断监听80端口，发现请求后就建立TCP连接；

客户端通过TCP连接向服务器发送HTTP请求，服务器以HTTP响应的形式返回请求的信息；

浏览器解析收到的信息并展示，TCP断开；

**特点**

① 无状态，每次请求返回的结果相同；

② 服务器支持大量并发HTTP请求；

③ 支持持久/非持久连接；

④ 支持流水线/非流水线方式；

**报文结构**

(1) 请求报文

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210925165235236.png" alt="image-20210925165235236" style="zoom:50%;" />

(2) 响应报文

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210925165308287.png" alt="image-20210925165308287" style="zoom:50%;" />

开始行 - 用于区分是请求报文还是响应报文；

首部行 - 用来说明一些信息，行数不确定；

实体主体 - 一般不用到；



一次真实的请求：

<img src="C:\Users\dzw\AppData\Roaming\Typora\typora-user-images\image-20210925165802532.png" alt="image-20210925165802532" style="zoom:50%;" />

## VI. 总结

|                  | 传输协议 | 端口 |
| ---------------- | -------- | ---- |
| FTP - 控制连接   | TCP      | 21   |
| FTP - 数据连接   | TCP      | 20   |
| 远程登陆TELNET   | TCP      | 23   |
| 简单邮件传输SMTP | TCP      | 25   |
| 邮局POP3         | TCP      | 110  |
| 超文本传输HTTP   | TCP      | 80   |
| 域名解析DNS      | UDP      | 53   |
| 简单文件传输TFTP | UDP      | 69   |
| 简单网络管理SNMP | UDP      | 161  |

